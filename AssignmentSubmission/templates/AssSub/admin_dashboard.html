{% extends 'AssSub/admin_base.html' %}

{% block content %}
<section class="bg-white rounded-xl shadow-sm border border-slate-200 mx-4 p-8 mb-8">
    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between space-y-6 lg:space-y-0">
        <div class="space-y-2">
            <h2 class="text-3xl font-bold text-slate-900">
                Welcome back, <span class="text-wrap text-blue-600">{{ request.user.email }}</span>
            </h2>
            <p class="text-slate-600 text-lg">
                Manage your assignments and track student submissions with ease.
            </p>
        </div>
        <div>
            <button onclick="document.getElementById('submission-create-modal').showModal()"
                class="inline-flex items-center px-6 py-3 bg-gradient-to-r from-blue-600 to-green-600 text-white font-medium rounded-lg hover:from-blue-700 hover:to-purple-700 transition-all duration-200 shadow-lg hover:shadow-xl">
                <i class="fas fa-plus mr-2"></i>
                Create Assignment
            </button>
        </div>
    </div>
</section>

<section class="bg-white rounded-xl shadow-sm border border-slate-200 mx-4 p-8 mb-8">
    <div class="stats stats-vertical lg:stats-horizontal">
        <div class="stat">
            <div class="stat-figure text-primary">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                    class="inline-block h-8 w-8 stroke-current">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z">
                    </path>
                </svg>
            </div>
            <div class="stat-title">Active Assignment</div>
            <div class="stat-value text-primary">{{ submissions.count }}</div>
            <div class="stat-desc">21% more than last month</div>
        </div>

        <div class="stat">
            <div class="stat-figure text-secondary">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                    stroke="currentColor" class="inline-block h-8 w-8 stroke-current">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                </svg>
            </div>
            <div class="stat-title">History</div>
            <div class="stat-value text-secondary">{{ submitteds.count }}</div>
            <div class="stat-desc">21% more than last month</div>
        </div>

        <div class="stat">
            <div class="stat-figure text-secondary">

            </div>
            <div class="stat-value">86%</div>
            <div class="stat-title">Tasks done</div>
            <div class="stat-desc text-secondary">31 tasks remaining</div>
        </div>

        <div class="stat">
            <div class="stat-title">Today‚Äôs Submissions</div>
            <div class="stat-value">{{ submissions.is_open.count }}</div>
        </div>
        <div class="stat">
            <div class="stat-title">Submission Rate</div>
            <div class="stat-value"> 89%</div>
        </div>
    </div>

    <!-- <div class="card-actions grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                    <button class="btn btn-primary w-full">‚ûï New Submission</button>
                                    <button class="btn w-full">üì• Import CSV</button>
                                    <button class="btn w-full">üì§ Export Data</button>
                                    <button class="btn w-full">üìÅ View Audit Logs</button>
                                </div> -->
    <!--Create Submission Modal-->
    <dialog id="submission-create-modal" class="modal">
        <div class="modal-box mx-4">
            <form method="dialog">
                <svg hx-patch="{% url 'admin-dashboard' %}" hx-target="body"
                    class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2" xmlns="http://www.w3.org/2000/svg"
                    fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="m9.75 9.75 4.5 4.5m0-4.5-4.5 4.5M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                </svg>
            </form>
            </form>
            <form id="sub-form" hx-post="{% url 'submission-create' %}" hx-target="#form-wrapper"
                hx-swap="outerHTML swap:0ms" hx-trigger="submit" hx-indicator="#spinner" enctype="multipart/form-data"
                class="w-full max-w-xl mx-auto p-6">
                {% csrf_token %}
                <div id="form-wrapper" class="space-y-6">
                    <h2 class="text-3xl font-bold text-center">Create Submission</h2>

                    <!-- Title -->
                    <div>
                        <label class="label">
                            <span class="label-text font-semibold">Title</span>
                        </label>
                        <input type="text" name="title" placeholder="Enter title" class="input input-bordered w-full" />
                    </div>

                    <!-- Course -->
                    <div>
                        <label class="label">
                            <span class="label-text font-semibold">Course</span>
                        </label>
                        <select name="course" class="select select-bordered w-full">
                            {% for value, label in form.course.field.choices %}
                            <option value="{{ value }}"  {% if form.course.value|stringformat:"s" == value|stringformat:"s" %}selected{% endif %}>
                                {{ label }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Format -->
                    <div>
                        <label class="label">
                            <span class="label-text font-semibold">Format</span>
                        </label>
                        <select name="format" class="select select-bordered w-full">
                            {% for label, value in form.format.field.choices %}
                            <option value="{{ label }}" {% if form.format.value == value %}selected{% endif %}>
                                {{ label }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Deadline -->
                    <div>
                        <label class="label">
                            <span class="label-text font-semibold">Deadline</span>
                        </label>
                        <input type="datetime-local" name="deadline" class="input input-bordered w-full" />
                    </div>

                    <!-- Note -->
                    <div>
                        <label class="label">
                            <span class="label-text font-semibold">Note</span>
                        </label>
                        <input type="text" name="note" placeholder="Optional note"
                            class="input input-bordered w-full" />
                    </div>

                    <!-- Submit Button -->
                    <div class="text-center">
                        <button type="submit" form="sub-form" class="btn btn-primary w-full">
                            <span>Submit</span>
                            <span id="spinner" class="loading loading-spinner htmx-indicator ml-2"></span>
                        </button>
                    </div>
                </div>
            </form>

        </div>
    </dialog>
</section>

<!--Create Submission Modal-->
<dialog id="submission-create-modal" class="modal">
    <div class="modal-box mx-4">
        <form method="dialog">
            <svg hx-patch="{% url 'admin-dashboard' %}" hx-target="body"
                class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2" xmlns="http://www.w3.org/2000/svg"
                fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                <path stroke-linecap="round" stroke-linejoin="round"
                    d="m9.75 9.75 4.5 4.5m0-4.5-4.5 4.5M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
            </svg>
        </form>
        </form>
        <form id="sub-form" hx-post="{% url 'submission-create' %}" hx-target="#form-wrapper"
            hx-swap="outerHTML swap:0ms" hx-trigger="submit" hx-indicator="#spinner" enctype="multipart/form-data"
            class="w-full max-w-xl mx-auto p-6">
            {% csrf_token %}
            <div id="form-wrapper" class="space-y-6">
                <h2 class="text-3xl font-bold text-center">Create Submission</h2>

                <!-- Title -->
                <div>
                    <label class="label">
                        <span class="label-text font-semibold">Title</span>
                    </label>
                    <input type="text" name="title" placeholder="Enter title" class="input input-bordered w-full" />
                </div>

                <!-- Course -->
                <div>
                    <label class="label">
                        <span class="label-text font-semibold">Course</span>
                    </label>
                    <select name="course" class="select select-bordered w-full">
                        {% for value, label in form.course.field.choices %}
                        <option value="{{ value }}" {% if form.course.value|stringformat:"s" == value|stringformat:"s" %}selected{% endif %}>
                            {{ label }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Format -->
                <div>
                    <label class="label">
                        <span class="label-text font-semibold">Format</span>
                    </label>
                    <select name="format" class="select select-bordered w-full">
                        {% for label, value in form.format.field.choices %}
                        <option value="{{ label }}" {% if form.format.value == value %}selected{% endif %}>
                            {{ label }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Deadline -->
                <div>
                    <label class="label">
                        <span class="label-text font-semibold">Deadline</span>
                    </label>
                    <input type="datetime-local" name="deadline" class="input input-bordered w-full" />
                </div>

                <!-- Note -->
                <div>
                    <label class="label">
                        <span class="label-text font-semibold">Note</span>
                    </label>
                    <input type="text" name="note" placeholder="Optional note" class="input input-bordered w-full" />
                </div>

                <!-- Submit Button -->
                <div class="text-center">
                    <button type="submit" form="sub-form" class="btn btn-primary w-full">
                        <span>Submit</span>
                        <span id="spinner" class="loading loading-spinner htmx-indicator ml-2"></span>
                    </button>
                </div>
            </div>
        </form>

    </div>
</dialog>


<section class="bg-white rounded-xl shadow-sm border border-slate-200 mx-4 p-8 mb-8">
    <!-- Mobile view: summary bars (stacked) -->
    <div class="grid grid-cols-1 md:grid-cols-3 md:gap-8 ">
    {% for submission in submissions %}
    {% if submission.is_open %}
        <div class="flex md:point hover:shadow-xl transition-all duration-200 hover:scale-[1.01] items-center relative justify-between p-4 border rounded-lg shadow-sm bg-white mb-6
            {% if submission.is_open %} cursor-pointer {% else %} cursor-not-allowed {% endif %}"
            onclick="if (window.innerWidth < 768) document.getElementById('modal-{{ submission.id }}').showModal()">


            <button class="absolute md:hidden btn btn-circle border-red-500 btn-error btn-soft -top-4 -right-4 hover:text-red-600"
                onclick="event.stopPropagation(); document.getElementById('close-{{ submission.id }}').showModal()">
                 <!-- trash icon -->
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                    stroke="currentColor" class="size-6">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" />
                </svg>
            </button>
            <div class="flex flex-col">
                <span class="font-semibold truncate">{{ submission.title|upper }}</span>
                <span class="text-xs text-gray-500 py-2 truncate">{{ submission.course.name }}</span>
                <span class="text-sm text-gray-600 pb-2">{{ submission.deadline }}</span>
                <div class="text-sm font-bold text-gray-600">
                   <span class="text-blue-600">{{ submission.submission_ratio|floatformat:1 }}%</span> of students submitted so far
                </div>
                <div class="hidden md:flex">
                <button class="btn btn-sm btn-ghost mt-2"
                    onclick="event.stopPropagation(); document.getElementById('modal-{{ submission.id }}').showModal()">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 0 1 0-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178Z" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
                    </svg>
                    View Students
                </button>
                <button class="btn btn-sm btn-soft btn-error mt-2 ml-2"
                    onclick="event.stopPropagation(); document.getElementById('close-{{ submission.id }}').showModal()">
                    Close this submission
                </button>
                
            </div>
            
            
        </div>
    </div>
    <!-- Modal -->
    <dialog id="close-{{ submission.id }}" class="modal modal-bottom sm:modal-middle">
        <div class="modal-box">
            <h3 class="font-bold text-lg">
                Are you sure you want to close this Assignment Submission?
            </h3>
            <div class="modal-action">
                <form method="dialog">
                    <button hx-post="{% url 'close-submission' submission.id %}" hx-target="body"
                        class="btn btn-error">Yes</button>
                    <button class="btn">No</button>
                </form>
            </div>
        </div>
    </dialog>

    <!-- Full card modal (for mobile expand) -->
    <dialog id="modal-{{ submission.id }}" class="modal modal-bottom sm:modal-middle">
        <div class="modal-box">
            <!-- reuse the full card details here -->
            <p class="text-2xl text-center">Submissions for: {{ submission.title }}</p>
            <div class="overflow-x-auto">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Email</th>
                            <th>ID</th>
                            <th>Submitted At</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for submitted in submission.studentsubmission_set.all %}
                        <tr>
                            <td>{{ submitted.student.email }}</td>
                            <td>{{ submitted.student.student_id }}</td>
                            <td>{{ submitted.submitted_at }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="3">No one has submitted yet</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <form method="dialog" class="modal-action">
                <button class="btn ">Download zip</button>
                <button class="btn">Close</button>
            </form>
        </div>
    </dialog>
    {% endif %}
    {% endfor %}
    </div>

    <!-- Desktop view: grid of full cards -->
    
</section>

<section class="bg-white rounded-xl shadow-sm border border-slate-200 mx-4 p-8 mb-8">
    <!-- Mobile view: summary bars (stacked) -->
    <p class="flex justify-center font-semibold text-center mb-4">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6 mx-2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
        </svg>
        Submission History
    </p>
        <div class="flex justify-center mb-4">
            <button 
                hx-get="{% url 'admin-dashboard' %}?status=all"
                hx-target="#submissions-container"
                hx-swap="innerHTML"
                class="tab border-b-2 border-blue-500 pb-1 text-gray-500 hover:text-gray-800">
                All
            </button>

            <button 
                hx-get="{% url 'admin-dashboard' %}?status=active"
                hx-target="#submissions-container"
                hx-swap="innerHTML"
                class="tab border-b-2 pb-1 text-gray-500 hover:text-gray-800">
                Active
            </button>

            <button 
                hx-get="{% url 'admin-dashboard' %}?status=closed"
                hx-target="#submissions-container"
                hx-swap="innerHTML"
                class="tab border-b-2 pb-1 text-gray-500 hover:text-gray-800">
                Closed
            </button>
        </div>
        <div id="submissions-container">
            {% include 'AssSub/partials/_admin_submissions_list.html' %}
        </div>
    

    <!-- Desktop view: grid of full cards -->
    
</section>
<script>
document.addEventListener("htmx:beforeRequest", function (evt) {
  const tabs = document.querySelectorAll(".tab");
  tabs.forEach(tab => tab.classList.remove("border-blue-500", "text-blue-600"));
  
  const clickedTab = evt.target;
  clickedTab.classList.add("border-blue-500", "text-blue-600");
});
</script>
{% endblock content %}